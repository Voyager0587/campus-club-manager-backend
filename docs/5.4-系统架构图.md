# 5.4 系统架构图

## 系统分层架构

本系统采用经典的MVC三层架构模式，前后端分离设计，通过RESTful API进行通信。

### 整体架构图

```plantuml
@startuml 系统分层架构
skinparam packageStyle rectangle
skinparam componentStyle rectangle

' 样式定义
skinparam component {
    BackgroundColor<<presentation>> lightblue
    BackgroundColor<<controller>> lightyellow
    BackgroundColor<<service>> lightgreen
    BackgroundColor<<persistence>> wheat
    BackgroundColor<<database>> lightcyan
    BackgroundColor<<infrastructure>> lavender
    BorderColor black
    FontSize 11
}

skinparam package {
    BackgroundColor white
    BorderColor darkblue
    FontSize 12
    FontStyle bold
}

' ==================== 展示层 ====================
package "展示层 (Presentation Layer)" {
    component "Vue3前端应用" as vue <<presentation>> {
        [路由管理\nVue Router]
        [状态管理\nPinia]
        [UI组件\nElement Plus]
        [HTTP客户端\nAxios]
    }
}

' ==================== 接口层 ====================
package "接口层 (Controller Layer)" <<controller>> {
    component "UserController\n用户管理" as userController
    component "ClubController\n社团管理" as clubController
    component "ActivityController\n活动管理" as activityController
    component "NotificationController\n通知管理" as notificationController
    component "FileController\n文件上传" as fileController
}

' ==================== 业务逻辑层 ====================
package "业务逻辑层 (Service Layer)" <<service>> {
    component "UserService\n用户业务" as userService
    component "ClubService\n社团业务" as clubService
    component "ActivityService\n活动业务" as activityService
    component "NotificationService\n通知业务" as notificationService
    component "FileService\n文件业务" as fileService
}

' ==================== 数据访问层 ====================
package "数据访问层 (Persistence Layer)" <<persistence>> {
    component "UserMapper\n用户数据访问" as userMapper
    component "ClubMapper\n社团数据访问" as clubMapper
    component "ActivityMapper\n活动数据访问" as activityMapper
    component "NotificationMapper\n通知数据访问" as notificationMapper

    component "MyBatis Plus\n(ORM框架)" as mybatisPlus
}

' ==================== 数据层 ====================
package "数据层 (Database Layer)" <<database>> {
    database "MySQL 8.0+\n关系型数据库" as mysql {
        frame "核心数据表" {
            [user 用户表]
            [club 社团表]
            [club_member 成员表]
            [activity 活动表]
            [activity_signup 报名表]
            [notification 通知表]
        }
    }
}

' ==================== 基础设施层 ====================
package "基础设施层 (Infrastructure Layer)" <<infrastructure>> {
    component "Sa-Token\n权限认证" as satoken
    component "Redis\n缓存服务" as redis
    component "阿里云OSS\n对象存储" as oss
    component "邮件服务\nSMTP" as mail
    component "阿里云AI\n智能问答" as ai
}

' ==================== 连接关系 ====================

' 前端到Controller
vue -down-> userController : "HTTP/HTTPS\nRESTful API"
vue -down-> clubController
vue -down-> activityController
vue -down-> notificationController
vue -down-> fileController

' Controller到Service
userController -down-> userService : "方法调用"
clubController -down-> clubService
activityController -down-> activityService
notificationController -down-> notificationService
fileController -down-> fileService

' Service到Mapper
userService -down-> userMapper : "数据操作"
clubService -down-> clubMapper
activityService -down-> activityMapper
notificationService -down-> notificationMapper

' Mapper到MyBatis Plus
userMapper -down-> mybatisPlus
clubMapper -down-> mybatisPlus
activityMapper -down-> mybatisPlus
notificationMapper -down-> mybatisPlus

' MyBatis Plus到MySQL
mybatisPlus -down-> mysql : "JDBC\nSQL查询"

' Service到基础设施
userService -right-> satoken : "认证授权"
clubService -right-> satoken
activityService -right-> satoken
notificationService -right-> satoken

userService -right-> redis : "会话缓存"
clubService -right-> redis
activityService -right-> redis

fileService -down-> oss : "文件上传"

notificationService -down-> mail : "邮件发送"

activityService -down-> ai : "AI对话"

' 注释说明
note right of vue
  <b>前端技术栈</b>
  - Vue 3 (组合式API)
  - TypeScript
  - Element Plus UI
  - Axios HTTP客户端
  - Pinia 状态管理
  - Vue Router 路由
end note

note right of userController
  <b>Controller层职责</b>
  - 接收HTTP请求
  - 参数校验(@Valid)
  - 权限验证(@SaCheckRole)
  - 调用Service处理业务
  - 返回统一响应(Result<T>)
end note

note right of userService
  <b>Service层职责</b>
  - 核心业务逻辑
  - 事务管理(@Transactional)
  - 异步处理(@Async)
  - 缓存管理
  - 调用第三方服务
end note

note right of userMapper
  <b>Mapper层职责</b>
  - SQL映射和执行
  - 使用MyBatis Plus
  - 自动生成CRUD
  - 自定义复杂查询
  - 分页查询支持
end note

note bottom of mysql
  <b>数据库特性</b>
  - 事务支持(ACID)
  - 逻辑删除
  - 乐观锁
  - 自动填充时间戳
  - 外键约束
end note

@enduml
```

### 架构说明

#### 1. **展示层 (Presentation Layer)**
- **技术栈**: Vue 3 + TypeScript + Element Plus
- **主要职责**:
  - 用户界面渲染
  - 用户交互处理
  - 状态管理(Pinia)
  - 路由导航(Vue Router)
  - HTTP请求发送(Axios)
- **通信方式**: 通过RESTful API与后端通信
- **数据格式**: JSON

#### 2. **接口层 (Controller Layer)**
- **技术栈**: Spring MVC + SpringDoc OpenAPI
- **主要职责**:
  - 定义RESTful API端点
  - 接收并验证请求参数(@Valid)
  - 权限验证(@SaCheckRole, @SaCheckLogin)
  - 调用Service层处理业务
  - 封装统一响应格式(Result<T>)
- **注解使用**:
  ```java
  @RestController
  @RequestMapping("/user")
  @RequiredArgsConstructor
  @Tag(name = "用户管理")
  public class UserController {
      @GetMapping("/info")
      @SaCheckRole("user")
      public Result<UserInfoVO> getUserInfo() { }
  }
  ```

#### 3. **业务逻辑层 (Service Layer)**
- **技术栈**: Spring + Sa-Token + Spring Cache
- **主要职责**:
  - 实现核心业务逻辑
  - 事务管理(@Transactional)
  - 数据转换(Entity ↔ VO/DTO)
  - 业务规则验证
  - 调用第三方服务
  - 异步任务处理(@Async)
- **设计模式**:
  - 接口与实现分离
  - 依赖注入(构造器注入)
  - 策略模式(不同审核策略)
- **示例代码**:
  ```java
  @Service
  @RequiredArgsConstructor
  @Slf4j
  public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements UserService {
      @Override
      @Transactional(rollbackFor = Exception.class)
      public LoginResponse login(LoginRequest request) {
          // 业务逻辑实现
      }
  }
  ```

#### 4. **数据访问层 (Persistence Layer)**
- **技术栈**: MyBatis Plus 3.5.9
- **主要职责**:
  - SQL映射与执行
  - 数据库CRUD操作
  - 复杂查询构建
  - 分页查询支持
  - 批量操作优化
- **MyBatis Plus特性**:
  - 自动生成CRUD方法
  - LambdaQueryWrapper条件构造
  - 分页插件
  - 逻辑删除
  - 自动填充
- **示例代码**:
  ```java
  @Mapper
  public interface UserMapper extends BaseMapper<User> {
      // 继承BaseMapper获得基础CRUD方法
      // 可自定义复杂查询
  }
  ```

#### 5. **数据层 (Database Layer)**
- **技术**: MySQL 8.0+ (微信云托管)
- **核心数据表**:
  - user: 用户信息
  - club: 社团信息
  - club_member: 社团成员关系
  - club_application: 社团申请
  - activity: 活动信息
  - activity_signup: 活动报名
  - notification: 通知消息
  - user_notification_setting: 通知设置
- **特性**:
  - InnoDB存储引擎
  - 事务支持(ACID)
  - 外键约束
  - 索引优化
  - 逻辑删除(is_deleted)
  - 时间戳自动更新

#### 6. **基础设施层 (Infrastructure Layer)**
包含系统运行所需的各种基础服务:

- **Sa-Token (权限认证)**:
  - 用户登录状态管理
  - Token生成与验证
  - 角色权限验证
  - Session管理

- **Redis (缓存服务)**:
  - Token缓存存储
  - 权限信息缓存
  - 热点数据缓存
  - 分布式锁

- **阿里云OSS (对象存储)**:
  - 图片文件存储
  - 文件上传下载
  - CDN加速

- **邮件服务 (SMTP)**:
  - 系统通知邮件
  - 异步发送

- **阿里云AI**:
  - 智能问答
  - 自然语言处理

---

## 请求处理流程

以"用户登录"为例,展示完整的请求处理流程:

```plantuml
@startuml 请求处理流程
autonumber

actor 用户
participant "Vue前端" as Vue
participant "Axios" as Axios
participant "UserController" as Controller
participant "UserService" as Service
participant "UserMapper" as Mapper
participant "MyBatis Plus" as MyBatis
database "MySQL" as DB
participant "Sa-Token" as SaToken
database "Redis" as Redis

用户 -> Vue: 输入用户名密码,点击登录
activate Vue

Vue -> Axios: 发起POST请求\n/user/login
activate Axios

Axios -> Controller: HTTP POST\n{username, password}
activate Controller

Controller -> Controller: 参数校验(@Valid)

Controller -> Service: login(request)
activate Service

Service -> Mapper: selectOne(username)
activate Mapper

Mapper -> MyBatis: 构建查询条件
activate MyBatis

MyBatis -> DB: SELECT * FROM user\nWHERE username = ?
activate DB
DB --> MyBatis: 返回用户数据
deactivate DB

MyBatis --> Mapper: User对象
deactivate MyBatis
Mapper --> Service: User对象
deactivate Mapper

Service -> Service: 验证密码\nencryptPassword()

Service -> SaToken: login(userId)\n生成Token
activate SaToken

SaToken -> Redis: 存储会话信息
activate Redis
Redis --> SaToken: 成功
deactivate Redis

SaToken --> Service: Token字符串
deactivate SaToken

Service -> Service: 构建响应VO\nconvertToVO()

Service --> Controller: LoginResponse\n{token, userInfo}
deactivate Service

Controller -> Controller: 封装Result<T>

Controller --> Axios: 200 OK\n{code:200, data:{token, userInfo}}
deactivate Controller

Axios --> Vue: Promise<Response>
deactivate Axios

Vue -> Vue: 存储Token到localStorage
Vue -> Vue: 跳转到首页

Vue --> 用户: 显示登录成功
deactivate Vue

@enduml
```

### 流程说明

1. **用户操作**: 用户在前端页面输入用户名密码
2. **前端处理**: Vue组件调用Axios发送HTTP请求
3. **Controller接收**:
   - 接收请求参数
   - 使用@Valid进行参数校验
   - 调用Service层处理
4. **Service处理**:
   - 调用Mapper查询用户
   - 验证密码是否正确
   - 调用Sa-Token生成Token
   - 构建响应VO对象
5. **Mapper查询**:
   - 使用MyBatis Plus构建查询
   - 执行SQL查询
   - 返回实体对象
6. **数据库操作**:
   - 执行SELECT查询
   - 返回结果集
7. **Token管理**:
   - Sa-Token生成Token
   - Redis存储会话信息
8. **响应返回**:
   - Service返回LoginResponse
   - Controller封装Result<T>
   - Axios接收响应
   - Vue存储Token并跳转

---

## 数据流转图

展示数据在各层之间的转换关系:

```plantuml
@startuml 数据流转
skinparam componentStyle rectangle

package "前端数据模型" {
    component [Form表单数据] as FormData
    component [TypeScript接口] as TSInterface
    component [Pinia状态] as PiniaState
}

package "Controller层数据" {
    component [Request DTO] as RequestDTO
    component [Response VO] as ResponseVO
    component [Result<T>] as Result
}

package "Service层数据" {
    component [Business Object] as BO
    component [Entity] as ServiceEntity
}

package "Mapper层数据" {
    component [Entity实体] as MapperEntity
    component [QueryWrapper] as Wrapper
}

package "数据库数据" {
    component [Table Row] as TableRow
}

' 请求流向
FormData -down-> TSInterface : "表单提交"
TSInterface -down-> RequestDTO : "JSON序列化"
RequestDTO -down-> BO : "参数映射"
BO -down-> ServiceEntity : "业务处理"
ServiceEntity -down-> MapperEntity : "数据传递"
MapperEntity -down-> Wrapper : "条件构建"
Wrapper -down-> TableRow : "SQL执行"

' 响应流向
TableRow -up-> MapperEntity : "结果映射"
MapperEntity -up-> ServiceEntity : "实体返回"
ServiceEntity -up-> BO : "业务封装"
BO -up-> ResponseVO : "数据转换"
ResponseVO -up-> Result : "统一封装"
Result -up-> TSInterface : "JSON反序列化"
TSInterface -up-> PiniaState : "状态更新"

note right of RequestDTO
  <b>DTO示例</b>
  LoginRequest
  RegisterRequest
  CreateClubRequest
  用于接收前端参数
end note

note right of ResponseVO
  <b>VO示例</b>
  UserInfoVO
  ClubDetailVO
  ActivityVO
  用于返回前端数据
end note

note right of ServiceEntity
  <b>Entity示例</b>
  User
  Club
  Activity
  对应数据库表结构
end note

@enduml
```

### 数据转换说明

#### 1. **请求方向 (前端 → 数据库)**
- **Form表单数据** → **TypeScript接口**: 表单验证和类型检查
- **TypeScript接口** → **Request DTO**: Axios序列化为JSON
- **Request DTO** → **Business Object**: Controller层参数映射
- **Business Object** → **Entity**: Service层业务处理
- **Entity** → **QueryWrapper**: Mapper层构建查询条件
- **QueryWrapper** → **Table Row**: MyBatis执行SQL

#### 2. **响应方向 (数据库 → 前端)**
- **Table Row** → **Entity**: MyBatis结果映射
- **Entity** → **Business Object**: Service层业务封装
- **Business Object** → **Response VO**: 数据转换和脱敏
- **Response VO** → **Result<T>**: Controller统一响应封装
- **Result<T>** → **TypeScript接口**: Axios反序列化
- **TypeScript接口** → **Pinia状态**: 状态管理存储

#### 3. **数据对象类型**

**DTO (Data Transfer Object)**:
```java
@Data
public class LoginRequest {
    @NotBlank(message = "用户名不能为空")
    private String username;

    @NotBlank(message = "密码不能为空")
    private String password;
}
```

**VO (View Object)**:
```java
@Data
public class UserInfoVO {
    private Long id;
    private String username;
    private String realName;
    private String email;
    private String avatar;
    // 不包含password等敏感信息
}
```

**Entity (数据库实体)**:
```java
@Data
@TableName("user")
public class User {
    @TableId(type = IdType.AUTO)
    private Long id;
    private String username;
    private String password; // 加密后的密码
    private String realName;
    private String email;
    // ... 对应数据库字段
}
```

---

## 架构优势

### 1. **分层解耦**
- 各层职责明确,互不干扰
- 易于维护和扩展
- 支持独立测试

### 2. **前后端分离**
- 前端专注UI交互
- 后端专注业务逻辑
- 通过API协议通信
- 支持多端适配

### 3. **技术选型合理**
- Spring Boot生态成熟
- MyBatis Plus提高开发效率
- Sa-Token轻量级权限框架
- Redis缓存提升性能

### 4. **扩展性强**
- 易于添加新功能模块
- 支持水平扩展
- 支持微服务改造

### 5. **安全性高**
- 多层权限验证
- 数据脱敏处理
- SQL注入防护
- XSS攻击防护
