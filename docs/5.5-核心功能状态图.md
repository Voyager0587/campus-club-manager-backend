# 5.5 核心功能状态图

状态图用于描述对象在其生命周期内的状态变化和状态转换条件，能够清晰地展示业务流程的各个阶段。

## 1. 社团申请状态图

社团申请从提交到最终结果的完整状态流转过程。

```plantuml
@startuml 社团申请状态图
[*] --> 待审核 : 用户提交申请

state 待审核 {
    [*] --> 等待审核
    等待审核 : 申请已提交
    等待审核 : 通知管理员
}

待审核 --> 审核通过 : 管理员批准
待审核 --> 审核拒绝 : 管理员拒绝

state 审核通过 {
    [*] --> 创建成员记录
    创建成员记录 --> 发送通知
    发送通知 --> [*]
}

state 审核拒绝 {
    [*] --> 记录拒绝原因
    记录拒绝原因 --> 发送拒绝通知
    发送拒绝通知 --> [*]
}

审核通过 --> 已加入社团 : 成为正式成员
审核拒绝 --> 申请结束 : 申请流程终止

已加入社团 --> [*]
申请结束 --> [*]

note right of 待审核
  <b>状态: PENDING</b>
  - 等待审核
  - 可查看申请状态
  - 管理员可审核
end note

note right of 审核通过
  <b>状态: APPROVED</b>
  - 自动添加为社团成员
  - 角色默认为member
  - 发送通过通知
end note

note right of 审核拒绝
  <b>状态: REJECTED</b>
  - 记录拒绝原因
  - 不创建成员记录
  - 发送拒绝通知
  - 可重新申请
end note

@enduml
```

### 状态说明

| 状态 | 枚举值 | 说明 | 可执行操作 |
|------|--------|------|------------|
| 待审核 | PENDING | 申请已提交，等待管理员审核 | 管理员可审核、用户可查看 |
| 审核通过 | APPROVED | 管理员批准申请 | 自动创建成员记录、发送通知 |
| 审核拒绝 | REJECTED | 管理员拒绝申请 | 记录原因、发送通知、允许重新申请 |
| 已加入社团 | - | 成为正式社团成员 | 参与社团活动、查看社团信息 |

### 状态转换条件

- **待审核 → 审核通过**: 管理员执行批准操作 + 社团状态正常
- **待审核 → 审核拒绝**: 管理员执行拒绝操作
- **审核通过 → 已加入社团**: 成员记录创建成功
- **审核拒绝 → 申请结束**: 拒绝通知发送完成

---

## 2. 活动状态图

活动从创建到完成的完整生命周期状态流转。

```plantuml
@startuml 活动状态图
[*] --> 草稿 : 社团负责人创建活动

state 草稿 {
    [*] --> 编辑中
    编辑中 : 填写活动信息
    编辑中 : 可修改所有字段
}

草稿 --> 待审核 : 提交审核

state 待审核 {
    [*] --> 等待系统审核
    等待系统审核 : 系统管理员审核
}

待审核 --> 已发布 : 审核通过
待审核 --> 草稿 : 审核拒绝\n(可修改后重新提交)

state 已发布 {
    [*] --> 报名中
    报名中 --> 报名截止 : 到达报名截止时间
    报名截止 --> 活动进行中 : 到达活动开始时间
}

已发布 --> 已取消 : 负责人/管理员取消

state 已取消 {
    [*] --> 取消报名
    取消报名 --> 退款处理
    退款处理 --> 发送取消通知
    发送取消通知 --> [*]
}

已发布 --> 已完成 : 到达活动结束时间

state 已完成 {
    [*] --> 签到统计
    签到统计 --> 生成活动报告
    生成活动报告 --> [*]
}

已取消 --> [*]
已完成 --> [*]

note right of 草稿
  <b>状态: DRAFT</b>
  - 仅创建者可见
  - 可任意修改
  - 未提交审核
end note

note right of 待审核
  <b>状态: PENDING</b>
  - 等待管理员审核
  - 不可修改
  - 不可报名
end note

note right of 已发布
  <b>状态: PUBLISHED</b>
  - 用户可见
  - 可以报名
  - 可以取消
  - 到时间自动流转
end note

note right of 已取消
  <b>状态: CANCELLED</b>
  - 取消所有报名
  - 发送通知
  - 不可恢复
end note

note right of 已完成
  <b>状态: COMPLETED</b>
  - 统计签到情况
  - 生成活动报告
  - 归档存储
end note

@enduml
```

### 状态说明

| 状态 | 枚举值 | 说明 | 可执行操作 |
|------|--------|------|------------|
| 草稿 | DRAFT | 活动创建中，未提交 | 编辑、删除、提交审核 |
| 待审核 | PENDING | 已提交，等待审核 | 管理员审核(通过/拒绝) |
| 已发布 | PUBLISHED | 审核通过，对外发布 | 报名、取消报名、签到、取消活动 |
| 已取消 | CANCELLED | 活动被取消 | 查看、导出数据 |
| 已完成 | COMPLETED | 活动已结束 | 查看、统计、导出报告 |

### 状态转换条件

- **草稿 → 待审核**: 社团负责人提交审核 + 活动信息完整
- **待审核 → 已发布**: 系统管理员审核通过
- **待审核 → 草稿**: 系统管理员审核拒绝
- **已发布 → 已取消**: 负责人或管理员主动取消
- **已发布 → 已完成**: 活动结束时间到达 + 系统自动流转

### 子状态说明

**已发布状态的子状态**:
- **报名中**: 当前时间在报名开始和截止时间之间
- **报名截止**: 超过报名截止时间，不可再报名
- **活动进行中**: 活动开始时间已到，可以签到

---

## 3. 活动报名状态图

用户报名活动后的状态流转过程。

```plantuml
@startuml 活动报名状态图
[*] --> 已报名 : 用户提交报名

state 已报名 {
    [*] --> 等待活动开始
    等待活动开始 : 报名成功
    等待活动开始 : 可取消报名
}

已报名 --> 已取消 : 用户主动取消
已报名 --> 已签到 : 到场签到
已报名 --> 缺席 : 活动结束未签到

state 已取消 {
    [*] --> 释放名额
    释放名额 --> 发送取消通知
    发送取消通知 --> [*]
}

state 已签到 {
    [*] --> 记录签到时间
    记录签到时间 --> 发送签到通知
    发送签到通知 --> [*]
}

state 缺席 {
    [*] --> 标记缺席
    标记缺席 --> 发送缺席通知
    发送缺席通知 --> [*]
}

已签到 --> 活动完成 : 活动结束
缺席 --> 活动完成 : 活动结束
已取消 --> [*]
活动完成 --> [*]

note right of 已报名
  <b>状态: REGISTERED</b>
  - 报名成功
  - 占用活动名额
  - 可取消报名
  - 等待活动开始
end note

note right of 已取消
  <b>状态: CANCELLED</b>
  - 释放活动名额
  - current_members - 1
  - 不可恢复
  - 可重新报名
end note

note right of 已签到
  <b>状态: CHECKED_IN</b>
  - 记录签到时间
  - 确认参与活动
  - 不可取消
end note

note right of 缺席
  <b>状态: ABSENT</b>
  - 未到场签到
  - 活动结束后自动标记
  - 或负责人手动标记
end note

@enduml
```

### 状态说明

| 状态 | 枚举值 | 说明 | 可执行操作 |
|------|--------|------|------------|
| 已报名 | REGISTERED | 报名成功，等待活动 | 取消报名、等待签到 |
| 已取消 | CANCELLED | 用户取消报名 | 释放名额、可重新报名 |
| 已签到 | CHECKED_IN | 用户已签到 | 无(等待活动结束) |
| 缺席 | ABSENT | 未签到，被标记缺席 | 无(记录缺席) |

### 状态转换条件

- **已报名 → 已取消**: 用户主动取消 + 在取消截止时间前
- **已报名 → 已签到**: 负责人扫码签到 + 活动进行中
- **已报名 → 缺席**: 活动结束时未签到 OR 负责人手动标记

### 业务规则

1. **取消报名限制**:
   - 活动开始前可取消
   - 活动开始后不可取消
   - 已签到状态不可取消

2. **名额管理**:
   - 报名成功: `current_members + 1`
   - 取消报名: `current_members - 1`
   - 达到上限不可报名

3. **签到规则**:
   - 只能在活动进行中签到
   - 签到后状态不可逆
   - 支持批量签到

---

## 4. 通知状态图

系统通知从创建到已读的状态流转。

```plantuml
@startuml 通知状态图
[*] --> 待发送 : 业务模块触发

state 待发送 {
    [*] --> 构建通知内容
    构建通知内容 --> 查询用户偏好
    查询用户偏好 --> [*]
}

待发送 --> 已发送 : 发送成功

state 已发送 {
    state fork_state <<fork>>
    [*] --> fork_state
    fork_state --> 站内通知已存储
    fork_state --> 邮件通知已发送

    站内通知已存储 --> join_state
    邮件通知已发送 --> join_state

    state join_state <<join>>
    join_state --> [*]
}

已发送 --> 未读 : 等待用户查看

state 未读 {
    [*] --> 显示小红点
    显示小红点 : read_flag = 0
    显示小红点 : 可查询、可标记已读
}

未读 --> 已读 : 用户点击查看

state 已读 {
    [*] --> 记录阅读时间
    记录阅读时间 --> 清除小红点
    清除小红点 : read_flag = 1
    清除小红点 : read_time = now()
}

已读 --> 已删除 : 用户删除(逻辑删除)

state 已删除 {
    [*] --> 标记删除
    标记删除 : is_deleted = 1
    标记删除 : 不可恢复
}

已删除 --> [*]

note right of 待发送
  <b>创建阶段</b>
  - 业务触发
  - 构建内容
  - 查询用户设置
  - 选择发送渠道
end note

note right of 已发送
  <b>发送阶段</b>
  - 站内通知: 写入数据库
  - 邮件通知: SMTP发送
  - 异步处理(@Async)
end note

note right of 未读
  <b>状态: read_flag = 0</b>
  - 显示在通知列表
  - 显示未读数量
  - 高优先级置顶
end note

note right of 已读
  <b>状态: read_flag = 1</b>
  - 记录阅读时间
  - 样式变为已读
  - 不计入未读数
end note

@enduml
```

### 状态说明

| 状态 | 字段值 | 说明 | 可执行操作 |
|------|--------|------|------------|
| 待发送 | - | 通知创建中 | 内部处理 |
| 已发送 | - | 发送完成 | 内部处理 |
| 未读 | read_flag = 0 | 等待用户查看 | 标记已读、删除 |
| 已读 | read_flag = 1 | 用户已查看 | 删除 |
| 已删除 | is_deleted = 1 | 逻辑删除 | 无 |

### 通知类型与优先级

**通知类型** (type字段):
- `system`: 系统通知
- `audit`: 审核消息(申请结果)
- `activity`: 活动提醒(报名、签到、取消)
- `club`: 社团通知(新公告、成员变更)

**优先级** (priority字段):
- 0: 低优先级(普通通知)
- 1: 普通优先级(默认)
- 2: 高优先级(重要提醒)
- 3: 紧急优先级(需立即处理)

### 发送渠道选择逻辑

```plantuml
@startuml 通知渠道选择
start

:业务模块触发通知;
:查询用户通知设置;

if (站内通知已启用?) then (是)
  :写入notification表;
else (否)
  :跳过站内通知;
endif

if (邮件通知已启用?) then (是)
  if (该类型通知允许邮件?) then (是)
    :发送邮件(异步);
  else (否)
    :跳过邮件发送;
  endif
else (否)
  :跳过邮件发送;
endif

:通知发送完成;
stop

@enduml
```

---

## 5. 用户账户状态图

用户账户从注册到禁用的状态管理。

```plantuml
@startuml 用户账户状态图
[*] --> 待激活 : 用户注册

state 待激活 {
    [*] --> 发送激活邮件
    发送激活邮件 : 邮箱验证码
    发送激活邮件 : 24小时内有效
}

待激活 --> 正常 : 邮箱验证通过
待激活 --> 注册失败 : 超时未激活

state 正常 {
    [*] --> 可正常使用
    可正常使用 : status = 1
    可正常使用 : 可登录、可操作
}

正常 --> 已禁用 : 管理员禁用\n违规行为

state 已禁用 {
    [*] --> 禁止登录
    禁止登录 : status = 0
    禁止登录 : 无法执行任何操作
}

已禁用 --> 正常 : 管理员解禁

正常 --> 已注销 : 用户主动注销

state 已注销 {
    [*] --> 逻辑删除
    逻辑删除 : is_deleted = 1
    逻辑删除 : 数据保留
    逻辑删除 : 不可恢复
}

注册失败 --> [*]
已注销 --> [*]

note right of 待激活
  <b>新注册用户</b>
  - 发送激活邮件
  - 需验证邮箱
  - 24小时超时
  (注: 当前版本可能直接激活)
end note

note right of 正常
  <b>状态: status = 1</b>
  - 可正常登录
  - 可执行所有操作
  - 权限受角色控制
end note

note right of 已禁用
  <b>状态: status = 0</b>
  - 登录时抛出异常
  - "账户已被禁用"
  - 管理员可解禁
end note

note right of 已注销
  <b>逻辑删除</b>
  - is_deleted = 1
  - 数据不物理删除
  - 用户名/邮箱/学号释放
  - 不可恢复
end note

@enduml
```

### 状态说明

| 状态 | 字段值 | 说明 | 可执行操作 |
|------|--------|------|------------|
| 待激活 | - | 新注册，待验证 | 邮箱验证 |
| 正常 | status = 1 | 正常使用 | 所有操作 |
| 已禁用 | status = 0 | 被管理员禁用 | 无(等待解禁) |
| 已注销 | is_deleted = 1 | 用户注销 | 无 |

### 状态转换条件

- **待激活 → 正常**: 邮箱验证通过(或系统配置直接激活)
- **正常 → 已禁用**: 管理员操作 + 禁用原因
- **已禁用 → 正常**: 管理员解禁操作
- **正常 → 已注销**: 用户主动注销 + 二次确认

---

## 6. 综合状态流转图

展示社团申请、活动报名的完整业务流程状态关系。

```plantuml
@startuml 综合业务状态流转
skinparam state {
    BackgroundColor<<club>> lightblue
    BackgroundColor<<activity>> lightgreen
    BackgroundColor<<signup>> lightyellow
}

state "用户注册登录" as user_state {
    [*] --> 正常用户
}

state "社团申请流程" as club_process <<club>> {
    正常用户 --> 提交申请
    提交申请 --> 待审核_club : PENDING
    待审核_club --> 审核通过_club : APPROVED
    待审核_club --> 审核拒绝_club : REJECTED
    审核通过_club --> 社团成员
}

state "活动管理流程" as activity_process <<activity>> {
    社团成员 --> 创建活动草稿 : 社团负责人
    创建活动草稿 --> 提交审核_activity : DRAFT
    提交审核_activity --> 待审核_activity : PENDING
    待审核_activity --> 已发布_activity : PUBLISHED
    待审核_activity --> 返回草稿 : 拒绝
    已发布_activity --> 已取消_activity : CANCELLED
    已发布_activity --> 已完成_activity : COMPLETED
}

state "活动报名流程" as signup_process <<signup>> {
    正常用户 --> 浏览活动
    浏览活动 --> 已发布_activity
    已发布_activity --> 提交报名 : 点击报名
    提交报名 --> 报名成功 : REGISTERED
    报名成功 --> 取消报名 : CANCELLED
    报名成功 --> 签到成功 : CHECKED_IN
    报名成功 --> 标记缺席 : ABSENT
}

note right of club_process
  <b>社团申请</b>
  - 用户申请加入
  - 管理员审核
  - 自动创建成员
end note

note right of activity_process
  <b>活动发布</b>
  - 负责人创建
  - 管理员审核
  - 自动流转状态
end note

note right of signup_process
  <b>活动报名</b>
  - 用户报名
  - 签到管理
  - 缺席统计
end note

@enduml
```

---

## 状态机设计总结

### 1. 设计原则

- **单一职责**: 每个状态只负责一个业务阶段
- **状态完备**: 覆盖所有可能的业务场景
- **转换明确**: 每个状态转换都有明确的触发条件
- **可追溯**: 记录状态变更时间和操作人

### 2. 实现方式

**枚举类定义**:
```java
public enum ApplicationStatus {
    PENDING("待审核"),
    APPROVED("审核通过"),
    REJECTED("审核拒绝");

    private final String description;

    ApplicationStatus(String description) {
        this.description = description;
    }
}
```

**状态转换验证**:
```java
public void reviewApplication(Long id, boolean approve) {
    ClubApplication application = getById(id);

    // 验证当前状态
    if (application.getStatus() != ApplicationStatus.PENDING) {
        throw new BusinessException("该申请已被处理");
    }

    // 执行状态转换
    application.setStatus(approve ?
        ApplicationStatus.APPROVED : ApplicationStatus.REJECTED);

    // 状态转换后的操作
    if (approve) {
        createMember(application);
    }

    updateById(application);
}
```

### 3. 状态持久化

所有状态变更都记录到数据库:
- 当前状态字段: `status`
- 审核时间字段: `review_time`
- 审核人字段: `reviewer_id`
- 更新时间字段: `update_time` (自动填充)

### 4. 状态通知

状态转换时触发通知:
```java
@Transactional
public void changeStatus(Long id, Status newStatus) {
    // 更新状态
    updateStatus(id, newStatus);

    // 发送通知
    notificationService.sendStatusChangeNotification(id, newStatus);
}
```

### 5. 状态查询优化

- 添加状态字段索引
- 使用枚举减少字符串比较
- 缓存常用状态统计数据

```java
// 查询待审核数量(缓存)
@Cacheable(value = "pending_count", key = "#clubId")
public Long getPendingCount(Long clubId) {
    return lambdaQuery()
        .eq(ClubApplication::getClubId, clubId)
        .eq(ClubApplication::getStatus, ApplicationStatus.PENDING)
        .count();
}
```
